sudo: false
dist: trusty
language: php

php:
    - '7.1'
    - '7.2'
    - nightly

git:
    depth: 5

cache:
    directories:
    - $HOME/.composer/cache

addons:
    apt:
        packages:
        - parallel

matrix:
    fast_finish: true
    allow_failures:
    - php: nightly

before_script:
    - phpenv config-rm xdebug.ini

    # Add composer's global bin directory to the path
    # see: https://github.com/drush-ops/drush#install---composer
    - export PATH="$HOME/.config/composer/vendor/bin:$PATH"
    - composer self-update
    - composer global require pdepend/pdepend phpmd/phpmd sebastian/phpcpd phploc/phploc squizlabs/php_codesniffer mayflower/php-codebrowser phpunit/phpunit behat/behat phpstan/phpstan phing/phing
    - composer install --no-dev --prefer-dist --ansi --no-interaction --no-suggest --no-progress --optimize-autoloader

script:
    - ls -d tests/Domain/* | parallel --gnu --keep-order 'echo "Running {} tests"; phpdbg -qrr phpunit -c phpunit.xml --colors=always {} || (echo -e "\e[41mFAILED\e[0m {}" && $(exit 1));'
